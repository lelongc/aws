<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Duyệt Repository</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />
    <style>
      /* Một vài tùy chỉnh nhỏ bổ sung */
      body {
        padding: 20px;
      }
      ul {
        list-style: none;
        padding-left: 0; /* Pico đã có style, bỏ padding mặc định */
      }
      li {
        margin-bottom: 8px;
        padding: 5px 0;
      }
      a {
        text-decoration: none; /* Pico xử lý phần này */
      }
      /* Giữ lại icon cho dễ nhìn */
      .folder::before {
        content: "📁 ";
        margin-right: 5px;
      }
      .file::before {
        content: "📄 ";
        margin-right: 5px;
      }
      #loading,
      #error {
        margin-top: 15px;
      }
      nav#breadcrumb {
        margin-bottom: 20px;
        font-size: 0.9em;
      }
      nav#breadcrumb a {
        font-weight: bold;
      }
      nav#breadcrumb span {
        margin: 0 5px;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <hgroup>
        <h1>Duyệt Repository</h1>
        <p>
          Xem nội dung của repo
          <strong><span id="repo-name-display"></span></strong>
        </p>
      </hgroup>

      <nav id="breadcrumb"></nav>

      <div id="file-browser">
        <ul id="file-list"></ul>
      </div>

      <div id="loading" aria-busy="true" style="display: none">
        Đang tải, vui lòng đợi...
      </div>
      <div id="error" style="display: none; color: var(--pico-color-red)"></div>
    </main>
    <script>
      const username = "lelongc"; // <-- THAY TÊN USERNAME GITHUB CỦA BẠN
      const repoName = "aws"; // <-- THAY TÊN REPOSITORY CỦA BẠN
      const fileList = document.getElementById("file-list");
      const loadingIndicator = document.getElementById("loading");
      const errorDisplay = document.getElementById("error");
      const breadcrumbNav = document.getElementById("breadcrumb");
      const repoNameDisplay = document.getElementById("repo-name-display");

      // Hiển thị tên repo
      repoNameDisplay.textContent = `${username}/${repoName}`;

      function updateBreadcrumb(path) {
        breadcrumbNav.innerHTML = ""; // Xóa breadcrumb cũ
        const parts = path.split("/").filter((p) => p); // Tách path thành các phần, loại bỏ rỗng

        // Thêm link gốc
        const rootLink = document.createElement("a");
        rootLink.href = "#";
        rootLink.textContent = "Gốc";
        rootLink.onclick = (e) => {
          e.preventDefault();
          fetchContents("");
        };
        breadcrumbNav.appendChild(rootLink);

        let currentPath = "";
        parts.forEach((part, index) => {
          const separator = document.createElement("span");
          separator.textContent = "/";
          breadcrumbNav.appendChild(separator);

          currentPath += (index > 0 ? "/" : "") + part;
          if (index === parts.length - 1) {
            // Phần tử cuối cùng (thư mục hiện tại) là text
            const currentFolder = document.createElement("span");
            currentFolder.textContent = part;
            breadcrumbNav.appendChild(currentFolder);
          } else {
            // Các phần tử trước là link
            const partLink = document.createElement("a");
            partLink.href = "#";
            partLink.textContent = part;
            // Capture currentPath tại thời điểm tạo link
            const pathForLink = currentPath;
            partLink.onclick = (e) => {
              e.preventDefault();
              fetchContents(pathForLink);
            };
            breadcrumbNav.appendChild(partLink);
          }
        });
      }

      async function fetchContents(path = "") {
        fileList.innerHTML = "";
        loadingIndicator.style.display = "block";
        loadingIndicator.setAttribute("aria-busy", "true");
        errorDisplay.style.display = "none";
        updateBreadcrumb(path); // Cập nhật breadcrumb

        const apiUrl = `https://api.github.com/repos/${username}/${repoName}/contents/${path}`;

        try {
          const response = await fetch(apiUrl);
          if (!response.ok) {
            let errorMsg = `Lỗi ${response.status}: ${response.statusText}`;
            try {
              const errorData = await response.json();
              errorMsg += ` - ${errorData.message || ""}`;
            } catch (e) {
              /* Ignore JSON parsing error */
            }
            // Check for rate limit specifically
            if (response.status === 403) {
              errorMsg +=
                ". Có thể bạn đã vượt quá giới hạn truy cập API của GitHub (60 yêu cầu/giờ nếu không đăng nhập). Thử lại sau.";
            }
            throw new Error(errorMsg);
          }
          const data = await response.json();

          data.sort((a, b) => {
            if (a.type === b.type) return a.name.localeCompare(b.name);
            return a.type === "dir" ? -1 : 1;
          });

          // Thêm link ".." nếu không ở gốc
          if (path !== "") {
            const parentPath = path.substring(0, path.lastIndexOf("/"));
            const listItem = document.createElement("li");
            const link = document.createElement("a");
            link.href = "#";
            link.innerHTML = "<strong>🔙 .. (Lên trên)</strong>"; // Dùng innerHTML để dùng strong
            link.onclick = (e) => {
              e.preventDefault();
              fetchContents(parentPath);
            };
            listItem.appendChild(link);
            fileList.appendChild(listItem);
          }

          data.forEach((item) => {
            const listItem = document.createElement("li");
            const link = document.createElement("a");
            listItem.classList.add(item.type === "dir" ? "folder" : "file");

            link.textContent = item.name;

            if (item.type === "dir") {
              link.href = "#";
              link.onclick = (e) => {
                e.preventDefault();
                fetchContents(item.path);
              };
            } else {
              // Link tới trang xem file trên GitHub (mở tab mới)
              link.href = item.html_url;
              link.target = "_blank";
              // Thêm thông tin kích thước file nếu có
              if (item.size) {
                const sizeKb = (item.size / 1024).toFixed(1);
                const sizeSpan = document.createElement("span");
                sizeSpan.textContent = ` (${sizeKb} KB)`;
                sizeSpan.style.fontSize = "0.8em";
                sizeSpan.style.color = "grey";
                link.appendChild(sizeSpan);
              }
            }
            listItem.appendChild(link);
            fileList.appendChild(listItem);
          });

          if (data.length === 0 && path !== "") {
            const emptyMsg = document.createElement("li");
            emptyMsg.textContent = "(Thư mục này trống)";
            emptyMsg.style.fontStyle = "italic";
            emptyMsg.style.color = "grey";
            fileList.appendChild(emptyMsg);
          }
        } catch (error) {
          console.error("Lỗi khi lấy dữ liệu:", error);
          errorDisplay.textContent = `Không thể tải nội dung: ${error.message}`;
          errorDisplay.style.display = "block";
        } finally {
          loadingIndicator.style.display = "none";
          loadingIndicator.setAttribute("aria-busy", "false");
        }
      }

      document.addEventListener("DOMContentLoaded", () => fetchContents());
    </script>
  </body>
</html>
