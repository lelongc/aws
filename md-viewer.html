<!DOCTYPE html>
<html lang="vi" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xem Markdown</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <style>
      body {
        padding-top: 20px;
        padding-bottom: 40px;
      }
      #md-content img {
        max-width: 100%;
        height: auto;
      }
      /* Tùy chỉnh style cho code block nếu cần */
      /* pre[class*="language-"] { background-color: #f8f9fa; }
        [data-bs-theme="dark"] pre[class*="language-"] { background-color: #212529; } */
    </style>
  </head>
  <body>
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="./index.html"
              ><i class="bi bi-house-door-fill"></i> Trang chủ duyệt file</a
            >
          </li>
          <li
            class="breadcrumb-item active"
            aria-current="page"
            id="md-filename"
          >
            Đang tải...
          </li>
        </ol>
      </nav>

      <h1 id="md-title">Đang tải...</h1>
      <hr />

      <div id="loading" class="text-center my-5">
        <div
          class="spinner-border text-primary"
          style="width: 3rem; height: 3rem"
          role="status"
        >
          <span class="visually-hidden">Đang tải nội dung Markdown...</span>
        </div>
        <p class="mt-2">Đang tải nội dung Markdown...</p>
      </div>

      <div id="error" class="alert alert-danger d-none" role="alert"></div>

      <div id="md-content" class="mt-4"></div>
    </div>

    <script>
      const loadingEl = document.getElementById("loading");
      const errorEl = document.getElementById("error");
      const contentEl = document.getElementById("md-content");
      const titleEl = document.getElementById("md-title");
      const filenameBreadcrumb = document.getElementById("md-filename");
      const currentHtml = document.documentElement;

      // --- Áp dụng theme đã lưu ---
      const savedTheme = localStorage.getItem("bsTheme") || "light";
      currentHtml.setAttribute("data-bs-theme", savedTheme);
      // Cập nhật theme cho PrismJS
      const prismTheme =
        savedTheme === "dark"
          ? "https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" // Theme tối
          : "https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"; // Theme sáng
      const prismLink = document.createElement("link");
      prismLink.rel = "stylesheet";
      prismLink.href = prismTheme;
      document.head.appendChild(prismLink);
      // --- Kết thúc áp dụng theme ---

      async function loadMarkdown() {
        const urlParams = new URLSearchParams(window.location.search);
        const mdFileUrl = urlParams.get("url"); // Lấy download_url từ tham số URL
        const mdFileName = urlParams.get("name") || "Markdown File"; // Lấy tên file

        titleEl.textContent = mdFileName;
        filenameBreadcrumb.textContent = mdFileName;

        if (!mdFileUrl) {
          showError("Không tìm thấy URL của file Markdown.");
          return;
        }

        try {
          // 1. Tải nội dung Markdown gốc
          const response = await fetch(decodeURIComponent(mdFileUrl));
          if (!response.ok) {
            throw new Error(
              `Lỗi tải file: ${response.status} ${response.statusText}`
            );
          }
          const markdownText = await response.text();

          // 2. Render Markdown sang HTML bằng marked.js
          // Cấu hình marked để tương thích GFM và thêm class cho bảng (nếu muốn)
          marked.setOptions({
            gfm: true, // Kích hoạt Github Flavored Markdown
            breaks: true, // Xuống dòng với chỉ 1 lần Enter
            headerIds: true, // Tự tạo ID cho các heading
            mangle: false, // Giữ nguyên email links
          });

          // Ghi đè renderer để thêm class Bootstrap cho bảng
          const renderer = new marked.Renderer();
          renderer.table = function (header, body) {
            return `<div class="table-responsive"><table class="table table-bordered table-striped">\n<thead>\n${header}</thead>\n<tbody>\n${body}</tbody>\n</table></div>\n`;
          };

          contentEl.innerHTML = marked.parse(markdownText, {
            renderer: renderer,
          });

          // 3. Highlight code block bằng Prism.js sau khi nội dung được thêm vào DOM
          Prism.highlightAllUnder(contentEl);

          loadingEl.style.display = "none"; // Ẩn loading
          errorEl.classList.add("d-none"); // Ẩn lỗi nếu có
        } catch (error) {
          console.error("Lỗi khi tải hoặc hiển thị Markdown:", error);
          showError(`Không thể hiển thị file: ${error.message}`);
        }
      }

      function showError(message) {
        loadingEl.style.display = "none";
        errorEl.textContent = message;
        errorEl.classList.remove("d-none");
      }

      // Load nội dung khi trang được tải
      document.addEventListener("DOMContentLoaded", loadMarkdown);
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
