
<img width="1285" height="687" alt="image" src="https://github.com/user-attachments/assets/35e2417c-cbe0-4b2b-90c5-41fa9b721ba6" />
<img width="1310" height="693" alt="image" src="https://github.com/user-attachments/assets/2d9e071f-2380-4540-b5c9-5a9cc586126b" />
<img width="1291" height="693" alt="image" src="https://github.com/user-attachments/assets/3d3471b4-39e3-4f1d-b646-e252d85c4c45" />

## üîí Hi·ªÉu chu·∫©n quy tr√¨nh **EBS Encryption v·ªõi KMS** ‚Äì Script th·ª±c t·∫ø, t·ªïng h·ª£p chi ti·∫øt nh·∫•t

---

## 1. C√°c kh√°i ni·ªám n·ªÅn t·∫£ng

- **CMK (Customer Master Key):** Kh√≥a g·ªëc do KMS qu·∫£n l√Ω, c√≥ th·ªÉ l√† AWS managed key ho·∫∑c t·ª± t·∫°o. Kh√≥a n√†y **kh√¥ng bao gi·ªù r·ªùi kh·ªèi KMS**.
- **DEK (Data Encryption Key):** Kh√≥a con sinh t·ª´ CMK, d√πng tr·ª±c ti·∫øp ƒë·ªÉ m√£ h√≥a/gi·∫£i m√£ block d·ªØ li·ªáu tr√™n EBS volume.
- **Envelope Encryption:** C∆° ch·∫ø AWS k·∫øt h·ª£p CMK & DEK:
    - KMS sinh DEK ‚Üí tr·∫£ v·ªÅ **2 b·∫£n**:
        - **Plaintext DEK:** D√πng ngay cho encrypt/decrypt tr√™n host.
        - **Encrypted DEK:** ƒê∆∞·ª£c m√£ h√≥a b·∫±ng CMK, l∆∞u trong metadata c·ªßa volume/snapshot.

---

## 2. Quy tr√¨nh chi ti·∫øt t·ª´ng b∆∞·ªõc

### A. **T·∫°o volume m·ªõi**

1. EBS g·ªçi KMS ƒë·ªÉ sinh DEK d·ª±a tr√™n CMK ch·ªâ ƒë·ªãnh.
2. KMS tr·∫£ v·ªÅ:
    - **Plaintext DEK** (ch·ªâ l∆∞u trong RAM host EC2/EBS, d√πng tr·ª±c ti·∫øp cho encrypt/decrypt).
    - **Encrypted DEK** (l∆∞u k√®m metadata volume/snapshot, kh√¥ng bao gi·ªù b·ªã l·ªô ra ngo√†i).
3. EBS ch·ªâ gi·ªØ plaintext DEK trong RAM host ƒëang attach volume.
4. Encrypted DEK d√πng l·∫°i cho c√°c l·∫ßn attach sau n√†y, ho·∫∑c khi t·∫°o snapshot t·ª´ volume.

### B. **Ghi d·ªØ li·ªáu v√†o EBS volume**

- ·ª®ng d·ª•ng/OS g·ª≠i data ‚Üí EC2 host/EBS d√πng plaintext DEK ƒë·ªÉ m√£ h√≥a block-level tr∆∞·ªõc khi ghi xu·ªëng disk.
- **Kh√¥ng c·∫ßn g·ªçi l·∫°i KMS m·ªói l·∫ßn ghi**, ch·ªâ d√πng plaintext DEK ƒë√£ sinh.

### C. **ƒê·ªçc d·ªØ li·ªáu t·ª´ EBS volume**

- EC2 host/EBS l·∫•y block ƒë√£ m√£ h√≥a t·ª´ disk.
- Plaintext DEK d√πng ƒë·ªÉ gi·∫£i m√£ ngay tr√™n host, tr·∫£ d·ªØ li·ªáu cho app/OS.
- **Kh√¥ng c·∫ßn g·ªçi l·∫°i KMS m·ªói l·∫ßn ƒë·ªçc**.

### D. **Reboot/attach volume sang host kh√°c**

- N·∫øu host kh√¥ng c√≤n plaintext DEK trong RAM:
    1. EBS l·∫•y encrypted DEK t·ª´ metadata volume.
    2. G·ª≠i encrypted DEK l√™n KMS ƒë·ªÉ nh·ªù gi·∫£i m√£ b·∫±ng CMK.
    3. KMS tr·∫£ v·ªÅ plaintext DEK m·ªõi cho host ƒë√≥.
    4. Host gi·ªØ plaintext DEK trong RAM ƒë·ªÉ ti·∫øp t·ª•c encrypt/decrypt.

---

## 3. Quy tr√¨nh snapshot v√† t·∫°o volume m·ªõi t·ª´ snapshot

- **Snapshot t·ª´ volume encrypted:**  
    - L∆∞u encrypted DEK c·ªßa volume g·ªëc k√®m snapshot.
- **T·∫°o volume m·ªõi t·ª´ snapshot:**  
    - DEK c·ªßa snapshot ƒë∆∞·ª£c d√πng l·∫°i cho volume m·ªõi (volume m·ªõi v·∫´n ƒë∆∞·ª£c m√£ h√≥a b·∫±ng DEK ƒë√≥).
    - Ch·ªâ sinh DEK m·ªõi khi t·∫°o volume m·ªõi ho√†n to√†n (kh√¥ng t·ª´ snapshot).

---

## 4. ƒê·∫∑c ƒëi·ªÉm b·∫£o m·∫≠t & v·∫≠n h√†nh

- **Plaintext DEK ch·ªâ t·ªìn t·∫°i trong RAM tr√™n host EC2/EBS, kh√¥ng ghi ra disk.**
- **Encrypted DEK lu√¥n l∆∞u c√πng metadata volume/snapshot, d√πng l·∫°i khi c·∫ßn.**
- **CMK kh√¥ng bao gi·ªù r·ªùi kh·ªèi KMS.**
- **KMS ch·ªâ b·ªã g·ªçi khi t·∫°o volume ho·∫∑c c·∫ßn gi·∫£i m√£ l·∫°i DEK (attach, reboot), KH√îNG m·ªói l·∫ßn IO (ƒë·ªçc/ghi).**
- **M·ªçi d·ªØ li·ªáu l∆∞u tr√™n EBS disk ho·∫∑c snapshot ƒë·ªÅu l√† encrypted-at-rest b·∫±ng DEK (kh√¥ng l·ªô plaintext ra ngo√†i host).**
- **OS/app ch·ªâ nh√¨n th·∫•y plain text, kh√¥ng bi·∫øt ph√≠a d∆∞·ªõi ƒëang m√£ h√≥a.**
- **Kh√¥ng th·ªÉ ‚Äúg·ª° m√£ h√≥a‚Äù/un-encrypt volume/snapshot tr·ª±c ti·∫øp, ch·ªâ c√≥ th·ªÉ copy data sang volume m·ªõi kh√¥ng m√£ h√≥a (OS-level).**

---

## 5. S∆° ƒë·ªì flowchart minh h·ªça t·ªïng th·ªÉ

```mermaid
flowchart TD
    A[T·∫°o Volume] --> B{KMS sinh DEK}
    B --> C[DEK plaintext (RAM host)]
    B --> D[DEK encrypted (metadata volume/snapshot)]
    C --> E[Ghi/ƒë·ªçc data: d√πng DEK plaintext RAM]
    D --> F{Reboot/attach host m·ªõi?}
    F -->|C√≥| G[L·∫•y encrypted DEK, g·ªçi KMS ƒë·ªÉ gi·∫£i m√£]
    G --> C
    F -->|Kh√¥ng| E
    D --> H[T·∫°o snapshot]
    H --> I[Snapshot l∆∞u encrypted DEK]
    I --> J[T·∫°o volume m·ªõi t·ª´ snapshot d√πng l·∫°i DEK snapshot]
```

---

## 6. C√°c m·∫πo exam, ph·ªèng v·∫•n, th·ª±c t·∫ø

- **DEK plaintext ch·ªâ t·ªìn t·∫°i trong RAM host EC2/EBS, kh√¥ng ghi ra disk.**
- **Encrypted DEK l∆∞u k√®m metadata volume/snapshot, d√πng l·∫°i khi attach/reboot.**
- **CMK lu√¥n ·ªü trong KMS, kh√¥ng l·ªô ra ngo√†i.**
- **KMS ch·ªâ ƒë∆∞·ª£c g·ªçi khi t·∫°o volume ho·∫∑c c·∫ßn gi·∫£i m√£ l·∫°i DEK, kh√¥ng m·ªói IO.**
- **Snapshot/volume m·ªõi t·ª´ snapshot d√πng l·∫°i encrypted DEK g·ªëc, kh√¥ng sinh DEK m·ªõi.**
- **Mu·ªën ‚Äúg·ª° m√£ h√≥a‚Äù ph·∫£i copy data ra volume m·ªõi kh√¥ng encrypted (OS-level).**
- **Kh√¥ng c√≥ ph√≠ th√™m, kh√¥ng gi·∫£m hi·ªáu nƒÉng khi d√πng EBS encryption.**

---

## 7. Script thao t√°c th·ª±c t·∫ø (AWS CLI)

```bash
# T·∫°o volume encrypted v·ªõi CMK c·ª• th·ªÉ
aws ec2 create-volume --size 10 --region us-east-1 --availability-zone us-east-1a --volume-type gp3 --encrypted --kms-key-id <your-kms-key-id>

# T·∫°o snapshot t·ª´ volume encrypted
aws ec2 create-snapshot --volume-id <volume-id> --description "Encrypted backup"

# T·∫°o volume m·ªõi t·ª´ snapshot encrypted (volume s·∫Ω lu√¥n encrypted)
aws ec2 create-volume --snapshot-id <snapshot-id> --availability-zone us-east-1a --volume-type gp3

# Ki·ªÉm tra tr·∫°ng th√°i encryption c·ªßa volume
aws ec2 describe-volumes --volume-ids <volume-id> --query "Volumes[*].Encrypted"
```

---

## 8. T·ªïng k·∫øt d·ªÖ nh·ªõ

- **EBS encryption = envelope encryption v·ªõi KMS, DEK plaintext ch·ªâ RAM, encrypted DEK l∆∞u metadata, CMK lu√¥n n·∫±m ·ªü KMS.**
- **Ch·ªâ c·∫ßn KMS khi t·∫°o volume ho·∫∑c attach/reboot, kh√¥ng m·ªói l·∫ßn IO.**
- **Snapshot v√† volume m·ªõi t·ª´ snapshot d√πng l·∫°i DEK g·ªëc.**
- **Kh√¥ng th·ªÉ ‚Äúun-encrypt‚Äù tr·ª±c ti·∫øp, ch·ªâ copy data ra volume m·ªõi (OS-level).**

---
