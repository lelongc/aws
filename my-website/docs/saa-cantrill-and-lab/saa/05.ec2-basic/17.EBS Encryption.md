

## 🔒 AWS EBS Encryption – Script thực tế đi làm & mẹo thi (đầy đủ)

---

## 1. EBS Encryption là gì? Kiến trúc & nguyên lý thực tế

- **EBS encryption = mã hóa dữ liệu lưu trên volume EBS và snapshot của nó, ở trạng thái “at rest”**
- **Mặc định:** EBS không mã hóa, dữ liệu ghi lên disk là plain text.
- **Kích hoạt encryption:**  
  - Dùng AWS managed key (`aws/ebs`) hoặc customer managed key (KMS key tự tạo).
  - Khi tạo volume encrypted, EBS dùng KMS để sinh ra **data encryption key (DEK) riêng cho từng volume**.
  - DEK chỉ lưu encrypted (do KMS mã hóa) cùng volume trên disk vật lý.

---

## 2. Quy trình hoạt động mã hóa
<img width="1285" height="687" alt="image" src="https://github.com/user-attachments/assets/35e2417c-cbe0-4b2b-90c5-41fa9b721ba6" />

- **Khi EC2 host cần đọc/ghi EBS encrypted volume:**
  - Host hỏi KMS để giải mã DEK của volume.
  - DEK decrypted chỉ lưu trong RAM của EC2 host đang dùng (không ghi ra disk).
  - Dữ liệu giữa EC2 instance và EBS volume được mã hóa bằng DEK (AES-256).
  - Dữ liệu lưu trên disk vật lý là **cipher text** (mã hóa).
  - Khi instance move sang host khác, DEK bị xóa khỏi RAM, cần KMS giải mã lại.
<img width="1310" height="693" alt="image" src="https://github.com/user-attachments/assets/2d9e071f-2380-4540-b5c9-5a9cc586126b" />

- **Snapshot của encrypted volume:**  
  - Sử dụng chung DEK của volume gốc.
  - Volume mới từ snapshot cũng mã hóa với DEK đó.
  - **Volume mới tạo từ snapshot encrypted = tiếp tục dùng DEK của snapshot đó!**

- **Volume mới tạo từ đầu (không phải từ snapshot):**
  - Sinh DEK mới, không dùng lại DEK của volume khác.

---

## 3. Mẹo exam: Các điểm “bẫy” thường gặp
<img width="1291" height="693" alt="image" src="https://github.com/user-attachments/assets/3d3471b4-39e3-4f1d-b646-e252d85c4c45" />

- **Account có thể bật mặc định encryption cho EBS (default KMS key).**
- **KMS key không trực tiếp mã hóa data, chỉ dùng để mã hóa DEK.**
- **Mỗi volume/snapshot chain có 1 DEK riêng biệt.**
- **Không thể “un-encrypt” volume/snapshot đã mã hóa – chỉ có thể copy data ra volume mới không mã hóa (OS-level).**
- **OS không nhìn thấy encryption – chỉ thấy plain text.**
- **Nếu cần OS tự quản lý key → dùng software disk encryption (LUKS, BitLocker, Veracrypt...), có thể kết hợp với EBS encryption nhưng hiếm khi cần.**
- **EBS encryption không có phí thêm, không giảm hiệu năng.**
- **AES-256 là thuật toán mã hóa EBS sử dụng.**

---

## 4. Quy trình thực tế (script đi làm)

### a. Tạo volume encrypted với AWS CLI

```bash
# Tạo volume encrypted với default KMS key
aws ec2 create-volume --size 10 --region us-east-1 --availability-zone us-east-1a --volume-type gp3 --encrypted

# Tạo volume encrypted với customer managed key
aws ec2 create-volume --size 10 --region us-east-1 --availability-zone us-east-1a --volume-type gp3 --encrypted --kms-key-id <your-kms-key-id>
```

### b. Xem trạng thái encryption của volume

```bash
aws ec2 describe-volumes --volume-ids <volume-id> --query "Volumes[*].Encrypted"
```

### c. Tạo snapshot từ encrypted volume (snapshot sẽ tự encrypted)

```bash
aws ec2 create-snapshot --volume-id <volume-id> --description "Encrypted backup"
```

### d. Tạo volume mới từ snapshot encrypted (volume sẽ luôn encrypted)

```bash
aws ec2 create-volume --snapshot-id <snapshot-id> --availability-zone us-east-1a --volume-type gp3
```

---

## 5. Xử lý khi cần “gỡ mã hóa” (un-encrypt/convert về unencrypted)

- **Không có cách trực tiếp!**
- Cách workaround:  
  - Attach volume encrypted vào EC2.
  - Copy toàn bộ data sang volume mới không encrypted (ví dụ: dùng `dd`, `rsync`, `cp`…).
  - Xóa volume/snapshot encrypted cũ nếu cần.

---

## 6. Script kiểm tra/copy data (Linux)

```bash
# Kiểm tra volume encrypted
lsblk
sudo file -s /dev/xvdf

# Copy data từ encrypted volume sang volume mới không encrypted
sudo mount /dev/xvdf /encrypted-vol
sudo mount /dev/xvdg /unencrypted-vol
sudo rsync -avh /encrypted-vol/ /unencrypted-vol/
```

---

## 7. Các câu hỏi exam/phỏng vấn hay gặp

- **“EBS encryption dùng thuật toán gì?”** → AES-256
- **“Có phí thêm khi dùng EBS encryption không?”** → Không
- **“Có thể “gỡ” encryption volume/snapshot không?”** → Không, chỉ copy data ra volume mới không encrypted.
- **“KMS key dùng như thế nào?”** → Mã hóa DEK, không mã hóa trực tiếp data.
- **“Volume mới từ snapshot encrypted có mã hóa không?”** → Có, dùng lại DEK của snapshot.
- **“OS có thấy mã hóa không?”** → Không, OS chỉ thấy plain text.

---

## 8. Tóm tắt nhớ lâu

- **EBS encryption nên bật mặc định cho bảo mật, không ảnh hưởng hiệu năng, không tăng phí.**
- **Mỗi volume/snapshot chain có DEK riêng.**
- **OS chỉ thấy plain text, encryption nằm ở layer EC2 host/EBS.**
- **Không thể un-encrypt trực tiếp, copy data sang volume mới nếu cần.**

---
