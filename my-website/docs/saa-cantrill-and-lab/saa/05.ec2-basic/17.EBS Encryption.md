

## ğŸ”’ AWS EBS Encryption â€“ Script thá»±c táº¿ Ä‘i lÃ m & máº¹o thi (Ä‘áº§y Ä‘á»§)

---

## 1. EBS Encryption lÃ  gÃ¬? Kiáº¿n trÃºc & nguyÃªn lÃ½ thá»±c táº¿

- **EBS encryption = mÃ£ hÃ³a dá»¯ liá»‡u lÆ°u trÃªn volume EBS vÃ  snapshot cá»§a nÃ³, á»Ÿ tráº¡ng thÃ¡i â€œat restâ€**
- **Máº·c Ä‘á»‹nh:** EBS khÃ´ng mÃ£ hÃ³a, dá»¯ liá»‡u ghi lÃªn disk lÃ  plain text.
- **KÃ­ch hoáº¡t encryption:**  
  - DÃ¹ng AWS managed key (`aws/ebs`) hoáº·c customer managed key (KMS key tá»± táº¡o).
  - Khi táº¡o volume encrypted, EBS dÃ¹ng KMS Ä‘á»ƒ sinh ra **data encryption key (DEK) riÃªng cho tá»«ng volume**.
  - DEK chá»‰ lÆ°u encrypted (do KMS mÃ£ hÃ³a) cÃ¹ng volume trÃªn disk váº­t lÃ½.

---

## 2. Quy trÃ¬nh hoáº¡t Ä‘á»™ng mÃ£ hÃ³a
<img width="1285" height="687" alt="image" src="https://github.com/user-attachments/assets/35e2417c-cbe0-4b2b-90c5-41fa9b721ba6" />

- **Khi EC2 host cáº§n Ä‘á»c/ghi EBS encrypted volume:**
  - Host há»i KMS Ä‘á»ƒ giáº£i mÃ£ DEK cá»§a volume.
  - DEK decrypted chá»‰ lÆ°u trong RAM cá»§a EC2 host Ä‘ang dÃ¹ng (khÃ´ng ghi ra disk).
  - Dá»¯ liá»‡u giá»¯a EC2 instance vÃ  EBS volume Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng DEK (AES-256).
  - Dá»¯ liá»‡u lÆ°u trÃªn disk váº­t lÃ½ lÃ  **cipher text** (mÃ£ hÃ³a).
  - Khi instance move sang host khÃ¡c, DEK bá»‹ xÃ³a khá»i RAM, cáº§n KMS giáº£i mÃ£ láº¡i.
<img width="1310" height="693" alt="image" src="https://github.com/user-attachments/assets/2d9e071f-2380-4540-b5c9-5a9cc586126b" />

- **Snapshot cá»§a encrypted volume:**  
  - Sá»­ dá»¥ng chung DEK cá»§a volume gá»‘c.
  - Volume má»›i tá»« snapshot cÅ©ng mÃ£ hÃ³a vá»›i DEK Ä‘Ã³.
  - **Volume má»›i táº¡o tá»« snapshot encrypted = tiáº¿p tá»¥c dÃ¹ng DEK cá»§a snapshot Ä‘Ã³!**

- **Volume má»›i táº¡o tá»« Ä‘áº§u (khÃ´ng pháº£i tá»« snapshot):**
  - Sinh DEK má»›i, khÃ´ng dÃ¹ng láº¡i DEK cá»§a volume khÃ¡c.

---

## 3. Máº¹o exam: CÃ¡c Ä‘iá»ƒm â€œbáº«yâ€ thÆ°á»ng gáº·p
<img width="1291" height="693" alt="image" src="https://github.com/user-attachments/assets/3d3471b4-39e3-4f1d-b646-e252d85c4c45" />

- **Account cÃ³ thá»ƒ báº­t máº·c Ä‘á»‹nh encryption cho EBS (default KMS key).**
- **KMS key khÃ´ng trá»±c tiáº¿p mÃ£ hÃ³a data, chá»‰ dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a DEK.**
- **Má»—i volume/snapshot chain cÃ³ 1 DEK riÃªng biá»‡t.**
- **KhÃ´ng thá»ƒ â€œun-encryptâ€ volume/snapshot Ä‘Ã£ mÃ£ hÃ³a â€“ chá»‰ cÃ³ thá»ƒ copy data ra volume má»›i khÃ´ng mÃ£ hÃ³a (OS-level).**
- **OS khÃ´ng nhÃ¬n tháº¥y encryption â€“ chá»‰ tháº¥y plain text.**
- **Náº¿u cáº§n OS tá»± quáº£n lÃ½ key â†’ dÃ¹ng software disk encryption (LUKS, BitLocker, Veracrypt...), cÃ³ thá»ƒ káº¿t há»£p vá»›i EBS encryption nhÆ°ng hiáº¿m khi cáº§n.**
- **EBS encryption khÃ´ng cÃ³ phÃ­ thÃªm, khÃ´ng giáº£m hiá»‡u nÄƒng.**
- **AES-256 lÃ  thuáº­t toÃ¡n mÃ£ hÃ³a EBS sá»­ dá»¥ng.**

---

## 4. Quy trÃ¬nh thá»±c táº¿ (script Ä‘i lÃ m)

### a. Táº¡o volume encrypted vá»›i AWS CLI

```bash
# Táº¡o volume encrypted vá»›i default KMS key
aws ec2 create-volume --size 10 --region us-east-1 --availability-zone us-east-1a --volume-type gp3 --encrypted

# Táº¡o volume encrypted vá»›i customer managed key
aws ec2 create-volume --size 10 --region us-east-1 --availability-zone us-east-1a --volume-type gp3 --encrypted --kms-key-id <your-kms-key-id>
```

### b. Xem tráº¡ng thÃ¡i encryption cá»§a volume

```bash
aws ec2 describe-volumes --volume-ids <volume-id> --query "Volumes[*].Encrypted"
```

### c. Táº¡o snapshot tá»« encrypted volume (snapshot sáº½ tá»± encrypted)

```bash
aws ec2 create-snapshot --volume-id <volume-id> --description "Encrypted backup"
```

### d. Táº¡o volume má»›i tá»« snapshot encrypted (volume sáº½ luÃ´n encrypted)

```bash
aws ec2 create-volume --snapshot-id <snapshot-id> --availability-zone us-east-1a --volume-type gp3
```

---

## 5. Xá»­ lÃ½ khi cáº§n â€œgá»¡ mÃ£ hÃ³aâ€ (un-encrypt/convert vá» unencrypted)

- **KhÃ´ng cÃ³ cÃ¡ch trá»±c tiáº¿p!**
- CÃ¡ch workaround:  
  - Attach volume encrypted vÃ o EC2.
  - Copy toÃ n bá»™ data sang volume má»›i khÃ´ng encrypted (vÃ­ dá»¥: dÃ¹ng `dd`, `rsync`, `cp`â€¦).
  - XÃ³a volume/snapshot encrypted cÅ© náº¿u cáº§n.

---

## 6. Script kiá»ƒm tra/copy data (Linux)

```bash
# Kiá»ƒm tra volume encrypted
lsblk
sudo file -s /dev/xvdf

# Copy data tá»« encrypted volume sang volume má»›i khÃ´ng encrypted
sudo mount /dev/xvdf /encrypted-vol
sudo mount /dev/xvdg /unencrypted-vol
sudo rsync -avh /encrypted-vol/ /unencrypted-vol/
```

---

## 7. CÃ¡c cÃ¢u há»i exam/phá»ng váº¥n hay gáº·p

- **â€œEBS encryption dÃ¹ng thuáº­t toÃ¡n gÃ¬?â€** â†’ AES-256
- **â€œCÃ³ phÃ­ thÃªm khi dÃ¹ng EBS encryption khÃ´ng?â€** â†’ KhÃ´ng
- **â€œCÃ³ thá»ƒ â€œgá»¡â€ encryption volume/snapshot khÃ´ng?â€** â†’ KhÃ´ng, chá»‰ copy data ra volume má»›i khÃ´ng encrypted.
- **â€œKMS key dÃ¹ng nhÆ° tháº¿ nÃ o?â€** â†’ MÃ£ hÃ³a DEK, khÃ´ng mÃ£ hÃ³a trá»±c tiáº¿p data.
- **â€œVolume má»›i tá»« snapshot encrypted cÃ³ mÃ£ hÃ³a khÃ´ng?â€** â†’ CÃ³, dÃ¹ng láº¡i DEK cá»§a snapshot.
- **â€œOS cÃ³ tháº¥y mÃ£ hÃ³a khÃ´ng?â€** â†’ KhÃ´ng, OS chá»‰ tháº¥y plain text.

---

## 8. TÃ³m táº¯t nhá»› lÃ¢u

- **EBS encryption nÃªn báº­t máº·c Ä‘á»‹nh cho báº£o máº­t, khÃ´ng áº£nh hÆ°á»Ÿng hiá»‡u nÄƒng, khÃ´ng tÄƒng phÃ­.**
- **Má»—i volume/snapshot chain cÃ³ DEK riÃªng.**
- **OS chá»‰ tháº¥y plain text, encryption náº±m á»Ÿ layer EC2 host/EBS.**
- **KhÃ´ng thá»ƒ un-encrypt trá»±c tiáº¿p, copy data sang volume má»›i náº¿u cáº§n.**

---
