## 🛠️ Demo thực tế: Làm việc với EBS & Instance Store Trên EC2 (script đầy đủ đi làm & đi thi)

---

## 1. Bối cảnh & lưu ý chi phí

- **Phần 1:** Demo EBS & snapshot (trong Free Tier)
- **Phần 2:** Demo Instance Store (có thể mất phí, ~0.13$/giờ cho instance lớn, không Free Tier)

---

## 2. Chuẩn bị môi trường

- Đăng nhập AWS management account, chọn region **N. Virginia (us-east-1)**
- Dùng CloudFormation template để tạo sẵn **3 EC2 instances** (2 ở AZ A, 1 ở AZ B)
- Mở EC2 Console > Instances, kiểm tra có 3 instance: instance-1a, instance-2a, instance-1ab

---

## 3. Kiểm tra EBS volumes

- EC2 Console > Elastic Block Store > Volumes
- Có 3 volume 8 GiB, mỗi cái gắn với 1 instance làm boot volume

---

## 4. Tạo EBS volume mới

- **Create Volume**
  - Volume type: **gp3**
  - Size: **10 GiB**
  - AZ: **us-east-1a**
  - Tag: key = `Name`, value = `EBS test volume`
- Bấm **Create volume**, chờ trạng thái “available”

---

## 5. Attach volume vào EC2

- Chọn volume vừa tạo > Actions > Attach volume
- Chọn instance **instance-1a** (chỉ thấy instance cùng AZ)
- Device: `/dev/sdf` (Linux có thể nhận là `/dev/xvdf`)
- Bấm **Attach**

---

## 6. SSH/Connect vào EC2 instance

- EC2 Console > Instances > Chọn **instance-1a** > Connect > EC2 Instance Connect
- User: `ec2-user`

---

## 7. Thao tác trên Linux (copy, paste từng dòng)

```bash
# Xem block devices
lsblk

# Kiểm tra file system (vd: trên xvdf)
sudo file -s /dev/xvdf
# Nếu trả về "data", chưa có file system

# Tạo file system (XFS)
sudo mkfs -t xfs /dev/xvdf

# Kiểm tra lại file system
sudo file -s /dev/xvdf

# Tạo mount point
sudo mkdir /EBS-test

# Mount volume vào thư mục
sudo mount /dev/xvdf /EBS-test

# Kiểm tra mount
df -h

# Chuyển vào thư mục mount
cd /EBS-test

# Tạo file test
sudo nano amazing-test-file.txt
# (Nhập nội dung, Ctrl+O để lưu, Ctrl+X để thoát)

# Hiển thị nội dung file
cat amazing-test-file.txt

# Liệt kê file
ls -l

# Reboot instance để test persistence
sudo reboot
# (Đợi vài phút, sau đó connect lại instance)
```

---

## 8. Kiểm tra lại sau reboot

- SSH lại instance, chạy:
```bash
lsblk
sudo mount /dev/xvdf /EBS-test
ls /EBS-test
cat /EBS-test/amazing-test-file.txt
```
- File vẫn còn, chứng minh **EBS là persistent storage**

---

## 9. Kiến thức bổ sung & mẹo đi thi

- **Chỉ attach EBS volume vào instance cùng AZ**
- **EBS volume tách rời vòng đời EC2:** Dừng/xóa instance, volume vẫn còn (trừ khi chọn delete on termination)
- **EBS volume dùng được cho nhiều EC2 (sequential attach, không parallel)**
- **Instance Store:** Chỉ add khi launch, mất data khi stop/start/terminate, chỉ dùng cho temp/cache
- **Boot volume chỉ dùng EBS, không dùng instance store**
- **EBS volume có thể tạo từ snapshot, restore/migrate/clone sang AZ/region khác**

---

## 10. Lệnh tham khảo khác

```bash
# Format ext4 thay cho xfs
sudo mkfs.ext4 /dev/xvdf

# Unmount volume
sudo umount /EBS-test

# Xóa volume khỏi EC2 (detach)
# AWS Console > Volumes > Actions > Detach
```

---

## 11. Lưu ý chi phí

- **EBS gp3:** ~$0.08/GB/tháng (10GB ~ $0.8/tháng)
- **Instance store:** Không tính riêng, đã include trong giá EC2
- **Part 2 (instance store):** Dùng instance lớn tốn ~0.13$/giờ
- **Snapshot:** ~$0.05/GB/tháng trên data thực dùng

---

**Tóm tắt:**
- EBS: Persistent, attach/detach linh hoạt, backup được (snapshot), chỉ attach cùng AZ.
- Instance store: Hiệu năng cao, ephemeral, chỉ add lúc launch, mất data khi stop/start, không backup.
- Thực hành đủ quy trình: tạo, attach, mount, test persistence, reboot, detach, xóa...

---
