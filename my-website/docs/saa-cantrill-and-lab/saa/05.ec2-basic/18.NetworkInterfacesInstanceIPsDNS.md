## üíª M·∫°ng EC2: ENI, IP, DNS ‚Äì Ki·∫øn tr√∫c, quy tr√¨nh & m·∫πo thi (ƒë·∫ßy ƒë·ªß)

---

## 1. Ki·∫øn tr√∫c m·∫°ng EC2 & ENI (Elastic Network Interface)

- **ENI (Elastic Network Interface):** L√† card m·∫°ng ·∫£o g·∫Øn v√†o EC2 instance.
- **M·ªói EC2 instance c√≥:**
    - **1 ENI ch√≠nh (primary):** G·∫Øn c·ªë ƒë·ªãnh, kh√¥ng th·ªÉ g·ª° ra.
    - **0 ho·∫∑c nhi·ªÅu ENI ph·ª• (secondary):** C√≥ th·ªÉ g·∫Øn/g·ª° v√† di chuy·ªÉn gi·ªØa c√°c instance.
- **Quan tr·ªçng:** T·∫•t c·∫£ c√°c ENI c·ªßa m·ªôt instance c√≥ th·ªÉ ·ªü c√°c subnet kh√°c nhau, nh∆∞ng **ph·∫£i n·∫±m trong c√πng m·ªôt Availability Zone (AZ)**.

---

## 2. C√°c th√†nh ph·∫ßn g·∫Øn v·ªõi m·ªôt ENI

<img width="718" height="423" alt="image" src="https://github.com/user-attachments/assets/4eac129c-28cb-434b-840f-96368f6108b4" />

C√°c thu·ªôc t√≠nh m·∫°ng th·ª±c ch·∫•t ƒë∆∞·ª£c g·∫Øn v√†o ENI, kh√¥ng ph·∫£i tr·ª±c ti·∫øp v√†o instance.

| Th√†nh ph·∫ßn               | M√¥ t·∫£ & L∆∞u √Ω                                                                                             |
|--------------------------|------------------------------------------------------------------------------------------------------------|
| **MAC Address**          | ƒê·ªãa ch·ªâ ph·∫ßn c·ª©ng tƒ©nh c·ªßa ENI. D√πng cho c√°c ph·∫ßn m·ªÅm license theo MAC.                                     |
| **Primary Private IPv4** | 1 ƒë·ªãa ch·ªâ private IPv4 ch√≠nh, l·∫•y t·ª´ d·∫£i IP c·ªßa subnet. Tƒ©nh, kh√¥ng ƒë·ªïi su·ªët v√≤ng ƒë·ªùi instance.                |
| **Secondary Private IPv4** | 0 ho·∫∑c nhi·ªÅu ƒë·ªãa ch·ªâ private IPv4 ph·ª•.                                                                      |
| **Public IPv4**          | 0 ho·∫∑c 1 ƒë·ªãa ch·ªâ public IPv4 (lo·∫°i dynamic).                                                               |
| **Elastic IP (EIP)**     | 1 EIP cho m·ªói ƒë·ªãa ch·ªâ private IPv4 (c·∫£ ch√≠nh v√† ph·ª•).                                                       |
| **IPv6 Address**         | 0 ho·∫∑c nhi·ªÅu ƒë·ªãa ch·ªâ IPv6 (m·∫∑c ƒë·ªãnh l√† public).                                                            |
| **Security Groups**      | G·∫Øn v√†o ENI. Mu·ªën c√≥ rule kh√°c nhau cho c√°c IP kh√°c nhau ‚Üí d√πng nhi·ªÅu ENI v·ªõi nhi·ªÅu security group.        |
| **Source/Dest Check**    | M·∫∑c ƒë·ªãnh b·∫≠t. T·∫Øt ƒëi ƒë·ªÉ instance ho·∫°t ƒë·ªông nh∆∞ m·ªôt NAT instance.                                            |

---

## 3. Ph√¢n lo·∫°i IP v√† DNS tr√™n EC2
<img width="667" height="414" alt="image" src="https://github.com/user-attachments/assets/49a23345-7770-48f2-9319-577a21fe9e6b" />

### A. Private IP & DNS

- **Private IPv4 (vd: `10.16.0.10`):**
    - Tƒ©nh, kh√¥ng ƒë·ªïi.
    - D√πng cho giao ti·∫øp n·ªôi b·ªô trong VPC.
- **Internal DNS (vd: `ip-10-16-0-10.ec2.internal`):**
    - T·ª± ƒë·ªông t·∫°o, tr·ªè ƒë·∫øn Private IPv4.
    - **Ch·ªâ ph√¢n gi·∫£i ƒë∆∞·ª£c b√™n trong VPC**.

### B. Public IP (Dynamic) & DNS

- **Public IPv4 (Dynamic):**
    - C·∫•p ph√°t t·ª± ƒë·ªông n·∫øu subnet ƒë∆∞·ª£c c·∫•u h√¨nh.
    - **Thay ƒë·ªïi khi instance stop/start**.
    - **Kh√¥ng ƒë·ªïi khi reboot (restart)**.
- **Public DNS (vd: `ec2-xx-xx-xx-xx.compute-1.amazonaws.com`):**
    - Tr·ªè ƒë·∫øn Public IPv4.
    - **ƒê·∫∑c bi·ªát:**
        - **B√™n trong VPC:** Ph√¢n gi·∫£i ra **Private IPv4** (ƒë·ªÉ t·ªëi ∆∞u traffic n·ªôi b·ªô).
        - **B√™n ngo√†i VPC:** Ph√¢n gi·∫£i ra **Public IPv4**.

### C. Elastic IP (EIP)

- **L√† ƒë·ªãa ch·ªâ Public IPv4 tƒ©nh, thu·ªôc v·ªÅ t√†i kho·∫£n AWS c·ªßa b·∫°n.**
- **Quy tr√¨nh ho·∫°t ƒë·ªông:**
    1. **Allocate EIP:** Xin m·ªôt EIP t·ª´ AWS.
    2. **Associate EIP:** G·∫Øn EIP v√†o m·ªôt ƒë·ªãa ch·ªâ private IPv4 tr√™n ENI.
    3. Khi g·∫Øn EIP, ƒë·ªãa ch·ªâ Public IPv4 (dynamic) c≈© s·∫Ω b·ªã **m·∫•t vƒ©nh vi·ªÖn**.
    4. Khi g·ª° EIP, instance s·∫Ω nh·∫≠n m·ªôt ƒë·ªãa ch·ªâ Public IPv4 (dynamic) **m·ªõi ho√†n to√†n**, kh√¥ng l·∫•y l·∫°i ƒë∆∞·ª£c IP c≈©.

---

## 4. M·∫πo thi & th·ª±c t·∫ø quan tr·ªçng (Exam Power-ups)

<img width="718" height="404" alt="image" src="https://github.com/user-attachments/assets/d2d18f09-2b28-4679-8f8d-c9113d4cd0ff" />

1.  **License theo MAC Address:** G·∫Øn ENI ph·ª• v√†o instance, d√πng MAC c·ªßa ENI ph·ª• ƒë·ªÉ license. Khi c·∫ßn di chuy·ªÉn license, ch·ªâ c·∫ßn g·ª° ENI ph·ª• v√† g·∫Øn sang instance kh√°c.
2.  **Multi-homed System:** D√πng nhi·ªÅu ENI cho c√°c m·ª•c ƒë√≠ch kh√°c nhau (vd: 1 ENI cho management, 1 ENI cho data). V√¨ Security Group g·∫Øn v√†o ENI, ƒë√¢y l√† c√°ch ƒë·ªÉ √°p c√°c b·ªô quy t·∫Øc firewall kh√°c nhau cho c√°c lu·ªìng traffic kh√°c nhau.
3.  **OS kh√¥ng th·∫•y Public IP:** H·ªá ƒëi·ªÅu h√†nh b√™n trong EC2 (Windows/Linux) **kh√¥ng bao gi·ªù nh√¨n th·∫•y Public IPv4**. N√≥ ch·ªâ l√†m vi·ªác v·ªõi Private IPv4. Qu√° tr√¨nh NAT 1-1 ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi Internet Gateway.
4.  **Public IP (Dynamic) vs. EIP (Static):**
    - Public IP (dynamic) s·∫Ω thay ƒë·ªïi khi **stop/start**.
    - Mu·ªën IP public c·ªë ƒë·ªãnh, **ph·∫£i d√πng Elastic IP (EIP)**.
5.  **Public DNS Resolution:** Nh·ªõ k·ªπ c∆° ch·∫ø ph√¢n gi·∫£i k√©p c·ªßa Public DNS:
    - **Trong VPC ‚Üí Private IP.**
    - **Ngo√†i VPC ‚Üí Public IP.**
    (R·∫•t quan tr·ªçng cho c√°c ch·ªß ƒë·ªÅ nh∆∞ VPC Peering, Hybrid Networking).
6.  **G·ª° EIP:** Khi g·ª° EIP, kh√¥ng c√≥ c√°ch n√†o l·∫•y l·∫°i ƒë∆∞·ª£c ƒë·ªãa ch·ªâ Public IP (dynamic) ban ƒë·∫ßu. Instance s·∫Ω ƒë∆∞·ª£c c·∫•p m·ªôt IP public m·ªõi.

---

## 5. S∆° ƒë·ªì ki·∫øn tr√∫c (t√≥m t·∫Øt)

```mermaid
graph TD
    subgraph "Availability Zone A"
        EC2["EC2 Instance"]
        subgraph "Subnet 1 (10.16.0.0/24)"
            ENI1["Primary ENI (eth0)"]
        end
        subgraph "Subnet 2 (10.16.1.0/24)"
            ENI2["Secondary ENI (eth1)"]
        end
    end

    EC2 -- G·∫Øn --o ENI1
    EC2 -- G·∫Øn --o ENI2

    subgraph "Thu·ªôc t√≠nh c·ªßa ENI1"
        MAC1["MAC Address"]
        PrivIP1["Private IP: 10.16.0.10"]
        PubIP1["Public IP / EIP"]
        SG1["Security Group A"]
    end

    subgraph "Thu·ªôc t√≠nh c·ªßa ENI2"
        MAC2["MAC Address"]
        PrivIP2["Private IP: 10.16.1.20"]
        PubIP2["Public IP / EIP"]
        SG2["Security Group B"]
    end

    ENI1 --- MAC1 & PrivIP1 & PubIP1 & SG1
    ENI2 --- MAC2 & PrivIP2 & PubIP2 & SG2

    style EC2 fill:#f9f,stroke:#333,stroke-width:2px
    style ENI1 fill:#bbf,stroke:#333,stroke-width:2px
    style ENI2 fill:#bbf,stroke:#333,stroke-width:2px
```

---

## 6. T·ªïng k·∫øt d·ªÖ nh·ªõ

- **ENI l√† card m·∫°ng ·∫£o, Security Group g·∫Øn v√†o ENI.**
- **T·∫•t c·∫£ ENI ph·∫£i trong c√πng m·ªôt AZ.**
- **OS ch·ªâ th·∫•y Private IP, kh√¥ng th·∫•y Public IP.**
- **Mu·ªën IP public c·ªë ƒë·ªãnh, d√πng EIP. G·∫Øn/g·ª° EIP l√†m m·∫•t IP public ƒë·ªông c≈©.**
- **Public DNS ph√¢n gi·∫£i ra Private IP (n·ªôi b·ªô VPC) ho·∫∑c Public IP (b√™n ngo√†i).**

---
??? info "Ghi ch√∫ th√™m & chi ti·∫øt"

    -   **S·ªë l∆∞·ª£ng ENI & IP ph·ª• thu·ªôc v√†o Instance Type:**  
        M·ªói lo·∫°i instance (vd: `t3.micro`, `m5.large`) c√≥ gi·ªõi h·∫°n kh√°c nhau v·ªÅ s·ªë l∆∞·ª£ng ENI c√≥ th·ªÉ g·∫Øn v√† s·ªë l∆∞·ª£ng ƒë·ªãa ch·ªâ IP ph·ª• tr√™n m·ªói ENI.
    
    -   **Primary ENI vs. Secondary ENI:**  
        -   **Primary ENI (eth0):** Kh√¥ng th·ªÉ g·ª° kh·ªèi instance, n√≥ g·∫Øn li·ªÅn v·ªõi v√≤ng ƒë·ªùi c·ªßa instance.  
        -   **Secondary ENI:** C√≥ th·ªÉ g·∫Øn/g·ª° v√† di chuy·ªÉn gi·ªØa c√°c instance (trong c√πng AZ). H·ªØu √≠ch cho c√°c k·ªãch b·∫£n **failover** ho·∫∑c **di chuy·ªÉn license**.
    
    -   **Source/Destination Check:**  
        -   Khi **b·∫≠t** (m·∫∑c ƒë·ªãnh), ENI s·∫Ω ki·ªÉm tra m·ªçi packet ƒëi qua n√≥. G√≥i tin s·∫Ω b·ªã **discard** n·∫øu:  
            -   IP **ngu·ªìn** kh√¥ng ph·∫£i l√† m·ªôt trong c√°c IP g·∫Øn v·ªõi ENI.  
            -   IP **ƒë√≠ch** kh√¥ng ph·∫£i l√† m·ªôt trong c√°c IP g·∫Øn v·ªõi ENI.  
    
            üëâ N√≥i c√°ch kh√°c: ENI ch·ªâ cho ph√©p g√≥i tin m√† n√≥ **th·ª±c s·ª± g·ª≠i ƒëi ho·∫∑c nh·∫≠n v·ªÅ ch√≠nh n√≥**. N√≥ s·∫Ω kh√¥ng cho g√≥i tin ‚Äúƒëi nh·ªù‚Äù qua n√≥.  
    
            **V√≠ d·ª•:** M·ªôt EC2 c√≥ ENI gi·ªëng nh∆∞ **c·ª≠a nh√† b·∫°n**.  
            - B·∫°n ch·ªâ nh·∫≠n th∆∞ g·ª≠i ƒë√∫ng ƒë·ªãa ch·ªâ nh√† m√¨nh.  
            - B·∫°n ch·ªâ g·ª≠i th∆∞ c√≥ ghi ƒë·ªãa ch·ªâ nh√† m√¨nh.  
            - N·∫øu c√≥ th∆∞ ghi ƒë·ªãa ch·ªâ nh√† kh√°c nh∆∞ng g·ª≠i qua b·∫°n, b·∫°n s·∫Ω **kh√¥ng chuy·ªÉn h·ªô** m√† v·ª©t ƒëi.  
    
        -   C·∫ßn **t·∫Øt (disable)** khi instance ƒë√≥ng vai tr√≤ **router, firewall, NAT instance**, ho·∫∑c b·∫•t k·ª≥ d·ªãch v·ª• n√†o c·∫ßn **chuy·ªÉn ti·∫øp traffic cho m√°y kh√°c**.
    
    -   **IPv6:**  
        Kh√¥ng c√≥ kh√°i ni·ªám *private* hay *public* nh∆∞ IPv4. T·∫•t c·∫£ ƒë·ªãa ch·ªâ IPv6 c·∫•p cho EC2 ƒë·ªÅu c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·ªãnh tuy·∫øn c√¥ng khai tr√™n Internet (t·∫•t nhi√™n v·∫´n b·ªã ki·ªÉm so√°t b·ªüi **Security Group** v√† **Network ACL**).
    
    -   **G·∫Øn nhi·ªÅu EIP tr√™n m·ªôt ENI:**  
        M·ªói ƒë·ªãa ch·ªâ private IPv4 tr√™n ENI c√≥ th·ªÉ g·∫Øn m·ªôt Elastic IP.  
        V√≠ d·ª•: ENI c√≥ 1 private IP ch√≠nh + 2 private IP ph·ª• ‚Üí g·∫Øn t·ªëi ƒëa **3 EIP**.
    
    -   **G√≥c nh√¨n kh√°i ni·ªám:**  
        C√≥ th·ªÉ coi **Primary ENI ch√≠nh l√† "instance"** t·ª´ g√≥c ƒë·ªô m·∫°ng. H·∫ßu h·∫øt c·∫•u h√¨nh m·∫°ng hi·ªÉn th·ªã tr√™n console EC2 th·ª±c ch·∫•t l√† thu·ªôc t√≠nh c·ªßa **Primary ENI**.
