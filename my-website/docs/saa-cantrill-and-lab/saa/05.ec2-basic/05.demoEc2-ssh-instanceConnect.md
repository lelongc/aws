1-Click Deployment

[https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0021-aws-associate-ec2-instance-connect-vs-ssh/A4L_VPC_PUBLICINSTANCE_AL2023.yaml&stackName=EC2INSTANCECONNECTvsSSH
](https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0021-aws-associate-ec2-instance-connect-vs-ssh/A4L_VPC_PUBLICINSTANCE_AL2023.yaml&stackName=EC2INSTANCECONNECTvsSSH
)


AWS IP Ranges
[https://ip-ranges.amazonaws.com/ip-ranges.json](https://ip-ranges.amazonaws.com/ip-ranges.json)

# üîê EC2 Connection Methods: SSH vs Instance Connect (Demo th·ª±c h√†nh)

---

## üéØ M·ª•c ti√™u Demo

So s√°nh 2 c√°ch connect EC2:
1. **SSH Client** (local machine)
2. **EC2 Instance Connect** (browser-based)

---

## Chu·∫©n b·ªã Infrastructure

### 1. T·∫°o Key Pair
```bash
EC2 Console ‚Üí Key Pairs ‚Üí Create Key Pair
Name: A4L
Format: .pem (Windows 10+/Mac/Linux) ho·∫∑c .ppk (Windows c≈©)
‚Üí Download file v·ªÅ m√°y
```

### 2. Deploy Infrastructure
```yaml
CloudFormation One-click deployment:
Stack name: EC2-instance-connect-vs-SSH
Key name: A4L (auto-populated)
‚Üí Wait for CREATE_COMPLETE
```

### 3. Ki·ªÉm tra Security Group
```yaml
EC2 Instance ‚Üí Security tab ‚Üí Inbound rules:
- Port 80 (HTTP): 0.0.0.0/0
- Port 22 (SSH IPv4): 0.0.0.0/0  
- Port 22 (SSH IPv6): ::/0
```

---

## Method 1: SSH Client (Local)

### 1. Connect Command
```bash
# AWS Console ‚Üí Instance ‚Üí Connect ‚Üí SSH Client
# Copy command example:
ssh -i "A4L.pem" ec2-user@ec2-xx-xx-xx-xx.compute-1.amazonaws.com
```

### 2. Fix Permissions Error
```bash
# L·ªói th∆∞·ªùng g·∫∑p: "Permissions 0644 for 'A4L.pem' are too open"
chmod 400 A4L.pem

# Windows: Right-click file ‚Üí Properties ‚Üí Security ‚Üí 
# Remove access for all users except current user
```

### 3. SSH Connection Process
```bash
# 1. Verify server fingerprint (type 'yes')
# 2. Authenticate with private key
# 3. Connected to EC2 instance terminal
```

---

## Method 2: EC2 Instance Connect

### 1. Connect via Browser
```yaml
EC2 Console ‚Üí Instance ‚Üí Connect ‚Üí EC2 Instance Connect
Instance ID: auto-filled
Public IP: auto-filled
User name: ec2-user (auto-detected)
‚Üí Click Connect
```

### 2. Key Differences vs SSH
```yaml
‚úÖ No key file needed
‚úÖ Uses AWS IAM permissions
‚úÖ Browser-based terminal
‚úÖ Good for team access
‚ùå Requires specific IP ranges in Security Group
```

---

## üî• Critical Security Demo

### Test 1: Restrict to "My IP"
```yaml
1. Security Group ‚Üí Edit Inbound Rules
2. SSH rule: Change 0.0.0.0/0 ‚Üí My IP
3. Save rules

Results:
‚úÖ SSH Client: Still works (from your IP)
‚ùå Instance Connect: Fails to connect
```

### Test 2: Allow Instance Connect Service
```yaml
1. Get AWS IP ranges: 
   https://ip-ranges.amazonaws.com/ip-ranges.json
   
2. Search for: "EC2_INSTANCE_CONNECT" + your region
   Example: "18.206.107.24/29" for us-east-1
   
3. Security Group: Add this IP range for SSH
4. Remove "My IP" rule

Results:
‚ùå SSH Client: Cannot connect
‚úÖ Instance Connect: Works perfectly
```

---

## Key Insights

### SSH Client
```yaml
How it works:
Your Machine ‚Üí Internet ‚Üí EC2 Instance

Requirements:
‚úÖ Private key file (.pem)
‚úÖ Correct file permissions (400)
‚úÖ Security Group allows your IP
‚úÖ Network connectivity

Pros/Cons:
‚úÖ Direct connection
‚úÖ Works from anywhere
‚ùå Key management overhead
‚ùå Each user needs key copy
```

### Instance Connect
```yaml
How it works:
Your Browser ‚Üí AWS Service ‚Üí EC2 Instance

Requirements:
‚úÖ IAM permissions
‚úÖ Security Group allows AWS service IPs
‚úÖ Correct username

Pros/Cons:
‚úÖ No key management
‚úÖ IAM-based access control
‚úÖ Audit trail in CloudTrail
‚ùå AWS service dependency
‚ùå Requires specific IP ranges
```

---

## Production Best Practices

### Security Group Strategy
```yaml
üîí Recommended approach:

Development:
- SSH from specific office IPs
- Instance Connect for team access

Production:
- Bastion hosts in public subnets
- Private instances via Session Manager
- No direct SSH from internet
```

### Key Management
```yaml
üîë SSH Key best practices:

‚úÖ One key per person/team
‚úÖ Rotate keys regularly  
‚úÖ Use AWS Systems Manager Session Manager
‚úÖ Audit access with CloudTrail
‚ùå Don't share private keys
‚ùå Don't commit keys to code repos
```

---

## Troubleshooting Common Issues

### SSH Connection Failed
```bash
# Check these in order:
1. Key file permissions: chmod 400 key.pem
2. Security Group allows your IP
3. Instance is running
4. Correct username (ec2-user, ubuntu, admin)
5. Network connectivity
```

### Instance Connect Failed
```yaml
üêõ Common issues:
1. Security Group doesn't allow AWS service IPs
2. Wrong username (check AMI documentation)
3. No IAM permissions for EC2:SendSSHPublicKey
4. Instance not supported (very old AMIs)
```

??? info " EC2:SendSSHPublicKey-EC2 Instance Connect"
    l√† d·ªãch v·ª• c·ªßa AWS cho ph√©p b·∫°n k·∫øt n·ªëi SSH ƒë·∫øn EC2 instance th√¥ng qua AWS Console ho·∫∑c CLI m√† kh√¥ng c·∫ßn qu·∫£n l√Ω SSH key truy·ªÅn th·ªëng.
   
    C√°ch ho·∫°t ƒë·ªông:
    - Khi b·∫°n d√πng Instance Connect, AWS s·∫Ω t·∫°m th·ªùi g·ª≠i m·ªôt SSH public key l√™n EC2 instance
    - Permission EC2:SendSSHPublicKey cho ph√©p user/role th·ª±c hi·ªán action n√†y
    - Key ch·ªâ t·ªìn t·∫°i trong th·ªùi gian ng·∫Øn (60 gi√¢y) ƒë·ªÉ thi·∫øt l·∫≠p k·∫øt n·ªëi SSH
    - T·∫°i sao c·∫ßn permission n√†y?
    - Kh√¥ng c√≥ permission: User kh√¥ng th·ªÉ g·ª≠i temporary SSH key l√™n instance
    - K·∫øt qu·∫£: Instance Connect s·∫Ω fail v·ªõi l·ªói authentication
    - Ho·∫∑c attach AWS managed policy:
    EC2InstanceConnectEndpoint
    
??? info "AMI username" 
    ## **T·∫°i sao c·∫ßn username?** , ƒë·ªÉ k·∫øt n·ªëi SSH, v√† username n√†y ph·ª• thu·ªôc v√†o **AMI (Amazon Machine Image)** m√† b·∫°n s·ª≠ d·ª•ng.
   
    Khi d√πng EC2 Instance Connect, AWS c·∫ßn bi·∫øt:
    - **User n√†o** tr√™n EC2 instance ƒë·ªÉ g·ª≠i temporary SSH key ƒë·∫øn
    - M·ªói AMI c√≥ **default user** kh√°c nhau

    ## **Username theo t·ª´ng lo·∫°i AMI:**
   
    | **AMI Type** | **Default Username** |
    |-------------|---------------------|
    | **Amazon Linux 2/2023** | `ec2-user` |
    | **Ubuntu** | `ubuntu` |
    | **CentOS** | `centos` |
    | **RHEL (Red Hat)** | `ec2-user` ho·∫∑c `root` |
    | **SUSE** | `ec2-user` |
    | **Debian** | `admin` |
    | **Windows** | N/A (kh√¥ng d√πng SSH) |
   

   
    ## **C√°ch ki·ªÉm tra username ƒë√∫ng:**
   
    ### **1. Trong AWS Console:**
    - V√†o EC2 ‚Üí Instance ‚Üí Select instance ‚Üí **Connect**
    - Trong tab "EC2 Instance Connect", s·∫Ω hi·ªán **Username** field
    - AWS Console th∆∞·ªùng t·ª± ƒë·ªông ƒë·ªÅ xu·∫•t username ph√π h·ª£p
   
    ### **2. Ki·ªÉm tra AMI documentation:**
    - V√†o EC2 ‚Üí Instance ‚Üí **AMI ID** ‚Üí Xem description
    - Ho·∫∑c check documentation c·ªßa AMI provider
   
    ### **3. Th·ª≠ c√°c username ph·ªï bi·∫øn:**
    - `ec2-user` (ph·ªï bi·∫øn nh·∫•t)
    - `ubuntu` (n·∫øu d√πng Ubuntu)
    - `admin` (n·∫øu d√πng Debian)
   

   
    ## **L·ªói th∆∞·ªùng g·∫∑p:**
   
    ‚ùå **Sai:** D√πng `root` cho Amazon Linux  
    ‚úÖ **ƒê√∫ng:** D√πng `ec2-user` cho Amazon Linux
   
    ‚ùå **Sai:** D√πng `ec2-user` cho Ubuntu  
    ‚úÖ **ƒê√∫ng:** D√πng `ubuntu` cho Ubuntu
   

   
    ## **Trong AWS CLI:**
    ```bash
    # V√≠ d·ª• connect v·ªõi username ƒë√∫ng
    aws ec2-instance-connect send-ssh-public-key \
        --instance-id i-1234567890abcdef0 \
        --instance-os-user ec2-user \  # Username ·ªü ƒë√¢y
        --ssh-public-key file://my-key.pub
    ```

    **AWS Console Instance Connect th∆∞·ªùng t·ª± ƒë·ªông detect v√† fill username** cho b·∫°n r·ªìi, n√™n th·ª±c t·∫ø √≠t khi ph·∫£i lo l·∫Øng v·ªÅ vi·ªác n√†y.
   
    ## **T·∫°i sao v·∫´n c√≥ l·ªói "Wrong username"?**
   
    D√π Console t·ª± ƒë·ªông suggest, nh∆∞ng v·∫´n c√≥ tr∆∞·ªùng h·ª£p:
   
    ### **1. Console detect sai:**
    - AMI custom ho·∫∑c √≠t ph·ªï bi·∫øn
    - Console suggest `ec2-user` nh∆∞ng th·ª±c t·∫ø c·∫ßn `ubuntu` ho·∫∑c ng∆∞·ª£c l·∫°i
    - AMI ƒë√£ b·ªã modify default user
   
    ### **2. User b·ªã disable/kh√¥ng t·ªìn t·∫°i:**
    - Admin ƒë√£ x√≥a ho·∫∑c disable default user
    - Instance ƒë∆∞·ª£c launch t·ª´ snapshot c√≥ user config kh√°c
   
    ### **3. AMI qu√° c≈©:**
    - M·ªôt s·ªë AMI c≈© kh√¥ng support Instance Connect
    - Thi·∫øu `ec2-instance-connect` package
   
   
    ## **Khi n√†o c·∫ßn quan t√¢m:**
   
    - **Console connect fail:** Th·ª≠ ƒë·ªïi username manually
    - **D√πng CLI/API:** Ph·∫£i specify username ch√≠nh x√°c
    - **Custom AMI:** C·∫ßn bi·∫øt user n√†o ƒë∆∞·ª£c t·∫°o
   
   
    ## **Th·ª±c t·∫ø:**
    - **90% tr∆∞·ªùng h·ª£p:** Console auto-detect ƒë√∫ng, kh√¥ng c·∫ßn lo
    - **10% tr∆∞·ªùng h·ª£p:** Ph·∫£i manual check v√† s·ª≠a username


---

## Exam Tips

### Key Points to Remember
- **Instance Connect ‚â† direct connection** t·ª´ browser
- **Instance Connect c·∫ßn AWS service IP ranges** trong Security Group
- **SSH Client c·∫ßn private key + ƒë√∫ng permissions**
- **Security Group rules apply differently** cho 2 methods

### Common Questions
1. **"User can't connect via Instance Connect but SSH works"** ‚Üí Check Security Group for AWS service IPs
2. **"SSH permission denied"** ‚Üí Check file permissions (chmod 400)
3. **"Best practice for team access"** ‚Üí Instance Connect v·ªõi IAM permissions
4. **"Production security"** ‚Üí Use Session Manager, not direct SSH

---

## Clean Up
```bash
CloudFormation ‚Üí Delete stack "EC2-instance-connect-vs-SSH"
```

---

**Takeaway:** Instance Connect t·ªët cho team access v·ªõi IAM control, SSH Client t·ªët cho individual access. Production n√™n d√πng Session Manager thay v√¨ expose SSH ra internet!
