1-Click Deployment

[https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0021-aws-associate-ec2-instance-connect-vs-ssh/A4L_VPC_PUBLICINSTANCE_AL2023.yaml&stackName=EC2INSTANCECONNECTvsSSH
](https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0021-aws-associate-ec2-instance-connect-vs-ssh/A4L_VPC_PUBLICINSTANCE_AL2023.yaml&stackName=EC2INSTANCECONNECTvsSSH
)


AWS IP Ranges
[https://ip-ranges.amazonaws.com/ip-ranges.json](https://ip-ranges.amazonaws.com/ip-ranges.json)

# ğŸ” EC2 Connection Methods: SSH vs Instance Connect (Demo thá»±c hÃ nh)

---

## ğŸ¯ Má»¥c tiÃªu Demo

So sÃ¡nh 2 cÃ¡ch connect EC2:
1. **SSH Client** (local machine)
2. **EC2 Instance Connect** (browser-based)

---

## Chuáº©n bá»‹ Infrastructure

### 1. Táº¡o Key Pair
```bash
EC2 Console â†’ Key Pairs â†’ Create Key Pair
Name: A4L
Format: .pem (Windows 10+/Mac/Linux) hoáº·c .ppk (Windows cÅ©)
â†’ Download file vá» mÃ¡y
```

### 2. Deploy Infrastructure
```yaml
CloudFormation One-click deployment:
Stack name: EC2-instance-connect-vs-SSH
Key name: A4L (auto-populated)
â†’ Wait for CREATE_COMPLETE
```

### 3. Kiá»ƒm tra Security Group
```yaml
EC2 Instance â†’ Security tab â†’ Inbound rules:
- Port 80 (HTTP): 0.0.0.0/0
- Port 22 (SSH IPv4): 0.0.0.0/0  
- Port 22 (SSH IPv6): ::/0
```

---

## Method 1: SSH Client (Local)

### 1. Connect Command
```bash
# AWS Console â†’ Instance â†’ Connect â†’ SSH Client
# Copy command example:
ssh -i "A4L.pem" ec2-user@ec2-xx-xx-xx-xx.compute-1.amazonaws.com
```

### 2. Fix Permissions Error
```bash
# Lá»—i thÆ°á»ng gáº·p: "Permissions 0644 for 'A4L.pem' are too open"
chmod 400 A4L.pem

# Windows: Right-click file â†’ Properties â†’ Security â†’ 
# Remove access for all users except current user
```

### 3. SSH Connection Process
```bash
# 1. Verify server fingerprint (type 'yes')
# 2. Authenticate with private key
# 3. Connected to EC2 instance terminal
```

---

## Method 2: EC2 Instance Connect

### 1. Connect via Browser
```yaml
EC2 Console â†’ Instance â†’ Connect â†’ EC2 Instance Connect
Instance ID: auto-filled
Public IP: auto-filled
User name: ec2-user (auto-detected)
â†’ Click Connect
```

### 2. Key Differences vs SSH
```yaml
âœ… No key file needed
âœ… Uses AWS IAM permissions
âœ… Browser-based terminal
âœ… Good for team access
âŒ Requires specific IP ranges in Security Group
```

---

## ğŸ”¥ Critical Security Demo

### Test 1: Restrict to "My IP"
```yaml
1. Security Group â†’ Edit Inbound Rules
2. SSH rule: Change 0.0.0.0/0 â†’ My IP
3. Save rules

Results:
âœ… SSH Client: Still works (from your IP)
âŒ Instance Connect: Fails to connect
```

### Test 2: Allow Instance Connect Service
```yaml
1. Get AWS IP ranges: 
   https://ip-ranges.amazonaws.com/ip-ranges.json
   
2. Search for: "EC2_INSTANCE_CONNECT" + your region
   Example: "18.206.107.24/29" for us-east-1
   
3. Security Group: Add this IP range for SSH
4. Remove "My IP" rule

Results:
âŒ SSH Client: Cannot connect
âœ… Instance Connect: Works perfectly
```

---

## Key Insights

### SSH Client
```yaml
How it works:
Your Machine â†’ Internet â†’ EC2 Instance

Requirements:
âœ… Private key file (.pem)
âœ… Correct file permissions (400)
âœ… Security Group allows your IP
âœ… Network connectivity

Pros/Cons:
âœ… Direct connection
âœ… Works from anywhere
âŒ Key management overhead
âŒ Each user needs key copy
```

### Instance Connect
```yaml
How it works:
Your Browser â†’ AWS Service â†’ EC2 Instance

Requirements:
âœ… IAM permissions
âœ… Security Group allows AWS service IPs
âœ… Correct username

Pros/Cons:
âœ… No key management
âœ… IAM-based access control
âœ… Audit trail in CloudTrail
âŒ AWS service dependency
âŒ Requires specific IP ranges
```

---

## Production Best Practices

### Security Group Strategy
```yaml
ğŸ”’ Recommended approach:

Development:
- SSH from specific office IPs
- Instance Connect for team access

Production:
- Bastion hosts in public subnets
- Private instances via Session Manager
- No direct SSH from internet
```

### Key Management
```yaml
ğŸ”‘ SSH Key best practices:

âœ… One key per person/team
âœ… Rotate keys regularly  
âœ… Use AWS Systems Manager Session Manager
âœ… Audit access with CloudTrail
âŒ Don't share private keys
âŒ Don't commit keys to code repos
```

---

## Troubleshooting Common Issues

### SSH Connection Failed
```bash
# Check these in order:
1. Key file permissions: chmod 400 key.pem
2. Security Group allows your IP
3. Instance is running
4. Correct username (ec2-user, ubuntu, admin)
5. Network connectivity
```

### Instance Connect Failed
```yaml
ğŸ› Common issues:
1. Security Group doesn't allow AWS service IPs
2. Wrong username (check AMI documentation)
3. No IAM permissions for EC2:SendSSHPublicKey
4. Instance not supported (very old AMIs)
```

---

## Exam Tips

### Key Points to Remember
- **Instance Connect â‰  direct connection** tá»« browser
- **Instance Connect cáº§n AWS service IP ranges** trong Security Group
- **SSH Client cáº§n private key + Ä‘Ãºng permissions**
- **Security Group rules apply differently** cho 2 methods

### Common Questions
1. **"User can't connect via Instance Connect but SSH works"** â†’ Check Security Group for AWS service IPs
2. **"SSH permission denied"** â†’ Check file permissions (chmod 400)
3. **"Best practice for team access"** â†’ Instance Connect vá»›i IAM permissions
4. **"Production security"** â†’ Use Session Manager, not direct SSH

---

## Clean Up
```bash
CloudFormation â†’ Delete stack "EC2-instance-connect-vs-SSH"
```

---

**Takeaway:** Instance Connect tá»‘t cho team access vá»›i IAM control, SSH Client tá»‘t cho individual access. Production nÃªn dÃ¹ng Session Manager thay vÃ¬ expose SSH ra internet!
