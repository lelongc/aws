## ğŸ’» Virtualization Fundamentals cho AWS EC2: Tá»« cÆ¡ báº£n Ä‘áº¿n SR-IOV (Äá»§ hiá»ƒu EC2 architecture)
Lesson Links

http://www.brendangregg.com/blog/2017-11-29/aws-ec2-virtualization-2017.html
---

## ğŸ¯ Táº¡i sao cáº§n hiá»ƒu Virtualization?

### **EC2 = Virtualization as a Service**
- **EC2 lÃ  Infrastructure as a Service (IaaS)** - cung cáº¥p virtual machines
- **Hiá»ƒu virtualization = hiá»ƒu Ä‘Æ°á»£c EC2 features hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o**
- **Essential cho exam** - nhiá»u cÃ¢u há»i vá» EC2 performance, enhanced networking, instance types

---

## PHáº¦N 1: Pre-Virtualization Era (Thá»i ká»³ trÆ°á»›c áº£o hÃ³a)
<img width="884" height="427" alt="image" src="https://github.com/user-attachments/assets/019efd62-4857-4267-a579-e3360c0e5304" />

### **Traditional Server Architecture**
```yaml
ğŸ–¥ï¸ Physical Server:
â”œâ”€â”€ Hardware Resources
â”‚   â”œâ”€â”€ CPU (Physical cores)
â”‚   â”œâ”€â”€ Memory (RAM)
â”‚   â”œâ”€â”€ Network Cards
â”‚   â””â”€â”€ Storage Devices
â”œâ”€â”€ Operating System (Privileged Mode)
â”‚   â”œâ”€â”€ Kernel (Direct hardware access)
â”‚   â””â”€â”€ OS Services
â””â”€â”€ Applications (User Mode)
    â”œâ”€â”€ Bob's Application
    â””â”€â”€ Julie's Application
```

### **Privilege Levels**
```yaml
ğŸ” CPU Privilege Levels:

Privileged Mode (Ring 0):
  âœ… Direct hardware access
  âœ… Memory management
  âœ… Only OS kernel operates here
  
User Mode (Ring 3):
  âŒ No direct hardware access
  âŒ Must use system calls
  âŒ Applications run here
```

### **Problem vá»›i Traditional Architecture**
- **1 server = 1 OS = resource waste** (server thÆ°á»ng chá»‰ dÃ¹ng 10-15% capacity)
- **Poor isolation** - 1 app crash cÃ³ thá»ƒ áº£nh hÆ°á»Ÿng toÃ n bá»™ server
- **High cost** - cáº§n separate physical server cho má»—i workload

---

## PHáº¦N 2: Virtualization Evolution (Tiáº¿n hÃ³a áº£o hÃ³a)
<img width="878" height="416" alt="image" src="https://github.com/user-attachments/assets/a6e77df0-672a-43b2-b6a8-3c145437df4e" />

### **Challenge: Multiple OS on Single Hardware**
```yaml
âŒ Problem:
  - Multiple OS muá»‘n cháº¡y privileged mode cÃ¹ng lÃºc
  - CPU chá»‰ cho phÃ©p 1 process á»Ÿ privileged mode
  - Conflict â†’ system crash

âœ… Solution: Virtualization!
```

---

## PHáº¦N 3: Emulated Virtualization (Software Virtualization)
<img width="877" height="345" alt="image" src="https://github.com/user-attachments/assets/21f70ceb-f89c-428a-a893-019607dcfd16" />

### **Architecture**
```yaml
ğŸ—ï¸ Emulated Virtualization:
â”œâ”€â”€ Physical Hardware
â”œâ”€â”€ Host OS (Privileged)
â”œâ”€â”€ Hypervisor (Software layer)
â””â”€â”€ Virtual Machines
    â”œâ”€â”€ Guest OS 1 + Apps
    â”œâ”€â”€ Guest OS 2 + Apps
    â””â”€â”€ Guest OS 3 + Apps
```

### **How it Works**
```yaml
ğŸ”„ Process:
1. Guest OS attempts privileged call
2. Hypervisor intercepts call
3. Binary Translation (software)
4. Execute on real hardware
5. Return result to Guest OS

ğŸŒ Performance: Very slow (50% performance penalty)
```

### **Characteristics**
- âœ… **Guest OS unmodified** - cháº¡y OS gá»‘c khÃ´ng cáº§n thay Ä‘á»•i
- âŒ **Very slow** - binary translation in software
- âŒ **High CPU overhead** - hypervisor pháº£i translate má»i privileged call
- ğŸ“Š **Use case:** Test environments, low-performance workloads

---

## PHáº¦N 4: Para-Virtualization
<img width="878" height="350" alt="image" src="https://github.com/user-attachments/assets/8a1a329f-92d4-4253-9515-60c4979f7f46" />

### **Core Concept**
```yaml
ğŸ”§ Para-Virtualization approach:
  - Modify Guest OS source code
  - Replace privileged calls â†’ hyper calls
  - Direct communication vá»›i hypervisor
  - No binary translation needed
```

### **Architecture Changes**
```yaml
ğŸ”„ Modified Guest OS:
  Original: App â†’ OS â†’ Hardware
  Para-virt: App â†’ Modified OS â†’ Hypervisor â†’ Hardware
  
  Hyper calls = optimized calls to hypervisor
```

### **Pros & Cons**
```yaml
âœ… Pros:
  - Much faster than emulated
  - Lower CPU overhead
  - Better performance

âŒ Cons:
  - Need modified OS (not all OS support)
  - Vendor-specific modifications
  - Limited OS compatibility
```

---

## PHáº¦N 5: Hardware-Assisted Virtualization (Game Changer!)
<img width="839" height="465" alt="image" src="https://github.com/user-attachments/assets/1b89c90b-757c-4059-8ee9-138905c82972" />

### **CPU Virtualization Extensions**
```yaml
ğŸš€ Hardware support:
  Intel: VT-x (Virtualization Technology)
  AMD: AMD-V (AMD Virtualization)
  
  CPU becomes "virtualization-aware"
```

### **How it Works**
```yaml
ğŸ”§ Process:
1. Guest OS makes privileged call
2. CPU traps call (hardware level)
3. Redirect to hypervisor (no software translation)
4. Hypervisor executes safely
5. Minimal performance impact

ğŸƒâ€â™‚ï¸ Performance: Near-native speed!
```

### **Benefits**
- âœ… **Near-native performance** - minimal overhead
- âœ… **Unmodified Guest OS** - run any OS
- âœ… **Hardware-level isolation** - better security
- âœ… **CPU-level support** - no software tricks needed

---

## PHáº¦N 6: SR-IOV (Single Root I/O Virtualization) - AWS Enhanced Networking
<img width="879" height="482" alt="image" src="https://github.com/user-attachments/assets/6d082e27-20c6-443c-a5b7-3ffcf79a93ee" />

### **The I/O Bottleneck Problem**
```yaml
âŒ Traditional virtual I/O:
  VM1 â†’ Virtual NIC â†’ Hypervisor â†’ Physical NIC
  VM2 â†’ Virtual NIC â†’ Hypervisor â†’ Physical NIC
  VM3 â†’ Virtual NIC â†’ Hypervisor â†’ Physical NIC
  
  Problem: Hypervisor becomes bottleneck for network I/O
```

### **SR-IOV Solution**
```yaml
âœ… SR-IOV magic:
  Physical NIC presents itself as multiple "mini-NICs"
  Each VM gets dedicated virtual NIC
  Direct hardware access, bypass hypervisor
  
  VM1 â†’ Dedicated Virtual NIC â†’ Direct to Physical NIC
  VM2 â†’ Dedicated Virtual NIC â†’ Direct to Physical NIC
```

### **SR-IOV Benefits**
```yaml
ğŸš€ Performance improvements:
  âœ… Higher bandwidth
  âœ… Lower latency
  âœ… Consistent latency (even under load)
  âœ… Lower CPU utilization
  âœ… Direct hardware access
```

### **AWS Implementation: Enhanced Networking**
```yaml
ğŸŒ AWS Enhanced Networking:
  Based on: SR-IOV technology
  Available on: Most modern EC2 instance types
  Provides: 
    - Up to 100 Gbps networking
    - Single digit microsecond latency
    - Packet per second performance
  
  Examples: C5n, M5n, R5n instances
```

---

## PHáº¦N 7: AWS Nitro System (Modern AWS Hypervisor)

### **Evolution to Nitro**
```yaml
ğŸ“ˆ AWS Hypervisor evolution:
  Gen 1: Modified Xen (software)
  Gen 2: Hardware-assisted Xen
  Gen 3: Nitro System (custom AWS)
  
  Nitro = AWS custom hypervisor stack
```

### **Nitro Advantages**
- **Better performance** - purpose-built for cloud
- **Enhanced security** - dedicated security chip
- **More instance types** - enables bare metal instances
- **Better resource utilization** - less hypervisor overhead

---

## PHáº¦N 8: Virtualization Impact on EC2 Features

### **Instance Performance Tiers**
```yaml
ğŸ“Š Performance correlation:

Basic instances (T3, T2):
  - Shared CPU, burstable
  - Software-based features
  
High-performance (C5, M5, R5):
  - Enhanced networking (SR-IOV)
  - Hardware acceleration
  - Nitro system
  
Specialized (C5n, M5n, R5n):
  - 100 Gbps networking
  - Advanced SR-IOV
  - Ultra-low latency
```

### **Feature Mapping**
```yaml
ğŸ”— Virtualization â†’ EC2 Features:

Hardware-assisted virtualization:
  â†’ Most EC2 instances
  
SR-IOV:
  â†’ Enhanced Networking
  â†’ Elastic Network Adapter (ENA)
  â†’ 100 Gbps networking
  
Nitro System:
  â†’ Bare metal instances (*.metal)
  â†’ Better performance/cost
  â†’ Advanced security features
```

---

## PHáº¦N 9: Checklist kiáº¿n thá»©c thi cert & phá»ng váº¥n

### **Core Concepts**
- [x] Virtualization cho phÃ©p multiple OS trÃªn single hardware
- [x] Hardware-assisted virtualization = near-native performance
- [x] SR-IOV bypasses hypervisor cho I/O operations
- [x] Enhanced Networking dá»±a trÃªn SR-IOV
- [x] Nitro System = AWS custom hypervisor

### **Performance Understanding**
- [x] Software virtualization = slow (binary translation)
- [x] Para-virtualization = faster (modified OS)
- [x] Hardware-assisted = near-native (CPU support)
- [x] SR-IOV = best I/O performance (direct hardware)

### **CÃ¢u há»i exam thÆ°á»ng gáº·p**
1. **"Enhanced Networking based on technology nÃ o?"** â†’ SR-IOV
2. **"AWS custom hypervisor tÃªn gÃ¬?"** â†’ Nitro System
3. **"Muá»‘n best network performance, dÃ¹ng instance type nÃ o?"** â†’ SR-IOV enabled types (C5n, M5n...)
4. **"Táº¡i sao má»™t sá»‘ instances cÃ³ better performance?"** â†’ Hardware acceleration, Nitro

---

## PHáº¦N 10: Real-world Applications

### **Khi nÃ o quan tÃ¢m SR-IOV/Enhanced Networking?**
```yaml
ğŸ’¼ Use cases:

High-frequency trading:
  âœ… Need ultra-low latency
  âœ… SR-IOV critical
  
Big data processing:
  âœ… High network throughput
  âœ… Enhanced networking essential
  
Microservices:
  âœ… High packet-per-second
  âœ… Consistent latency important
```

### **Instance Selection Strategy**
```yaml
ğŸ¯ Choose instances based on virtualization features:

Basic workloads: T3, T2 (sufficient)
Network-intensive: C5n, M5n, R5n (SR-IOV)
Compute-intensive: C5, M5, R5 (Nitro)
Special requirements: *.metal (bare metal)
```

---

## PHáº¦N 11: Tá»•ng káº¿t

- **Virtualization evolution: Software â†’ Para-virt â†’ Hardware-assisted â†’ SR-IOV**
- **AWS EC2 leverages latest virtualization tech** for best performance
- **Understanding virtualization helps choose right instance types**
- **SR-IOV = key to Enhanced Networking** vÃ  high-performance applications
- **Nitro System = AWS's answer** to modern virtualization challenges

---

**Ghi nhá»›:** Virtualization knowledge giÃºp báº¡n hiá»ƒu táº¡i sao certain EC2 features work the way they do, vÃ  cÃ¡ch optimize workloads cho best performance!

**Next:** Deep dive vÃ o EC2 instance types vÃ  AWS Nitro System!
