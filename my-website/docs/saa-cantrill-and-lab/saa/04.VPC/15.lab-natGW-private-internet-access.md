1-CLICK Deployment
https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://learn-cantrill-labs.s3.amazonaws.com/awscoursedemos/0003-aws-associate-vpc-private-internet-access-using-nat-gateways/a4l_vpc_privateinternet_nat.yaml&stackName=A4L

## ğŸ› ï¸ DEMO: Implement Multi-AZ NAT Gateway Architecture (Step-by-step cá»±c chi tiáº¿t)

---
<img width="900" height="494" alt="image" src="https://github.com/user-attachments/assets/10718675-3f6d-4d01-ba1c-adc9d05a149e" />

## ğŸ¯ Má»¥c tiÃªu demo nÃ y
- Triá»ƒn khai **3 NAT Gateways** trong 3 AZ Ä‘á»ƒ Ä‘áº¡t **regional resilience**
- Cáº¥u hÃ¬nh **route tables** cho private subnets
- Test **outbound Internet connectivity** tá»« private EC2 instance
- Thá»±c hÃ nh **clean-up** Ä‘áº§y Ä‘á»§ Ä‘á»ƒ khÃ´ng máº¥t phÃ­

---

## ğŸ“‹ Kiá»ƒm tra Ä‘iá»u kiá»‡n trÆ°á»›c khi báº¯t Ä‘áº§u

### **Environment Setup**
- [x] Login vá»›i IAM admin user
- [x] Region: US East 1 (N. Virginia)
- [x] Account Ä‘Ã£ clean tá»« demo trÆ°á»›c
- [x] CÃ³ CloudFormation one-click deployment link

---

## PHáº¦N 1: Deploy Base Infrastructure vá»›i CloudFormation

### **1.1. Apply CloudFormation Template**
```yaml
ğŸ“ CloudFormation Console â†’ Create Stack

Template: One-click deployment link (provided with lesson)
Stack name: A4L
Parameters: Pre-populated
Capabilities: â˜‘ï¸ Check acknowledgment
Action: Create Stack

â³ Wait for: CREATE_COMPLETE status
```

### **1.2. Verify Infrastructure**
```yaml
ğŸ“ CloudFormation â†’ A4L Stack â†’ Resources tab

Key resource: A4L-InternalTest (EC2 instance)
Location: Private subnet (App-A)
Purpose: Test NAT Gateway functionality

Wait for:
  âœ… Instance status: 2/2 checks passed
  âœ… Session Manager connectivity available
```

### **1.3. Test Current Connectivity**
```yaml
ğŸ“ EC2 Console â†’ A4L-InternalTest â†’ Connect â†’ Session Manager

Test command: ping 1.1.1.1
Expected result: âŒ No connectivity (timeout)
Reason: No NAT Gateway configured yet
```

---

## PHáº¦N 2: Create NAT Gateways (3 AZ Design)

### **2.1. Create NAT Gateway A**
```yaml
ğŸ“ VPC Console â†’ NAT Gateways â†’ Create NAT Gateway

Name: A4L-VPC1-NATGW-A
Subnet: SN-Web-A (public subnet trong AZ-A)
Elastic IP: Click "Allocate Elastic IP"
Connectivity type: Public (default)
Action: Create NAT Gateway
```

### **2.2. Create NAT Gateway B**
```yaml
ğŸ“ Repeat process for AZ-B

Name: A4L-VPC1-NATGW-B  
Subnet: SN-Web-B (public subnet trong AZ-B)
Elastic IP: Allocate new Elastic IP
Action: Create NAT Gateway
```

### **2.3. Create NAT Gateway C**
```yaml
ğŸ“ Repeat process for AZ-C

Name: A4L-VPC1-NATGW-C
Subnet: SN-Web-C (public subnet trong AZ-C) 
Elastic IP: Allocate new Elastic IP
Action: Create NAT Gateway

â³ Wait for: All 3 NAT Gateways â†’ "Available" status
```

---

## PHáº¦N 3: Create Private Route Tables

### **3.1. Route Table for AZ-A**
```yaml
ğŸ“ VPC Console â†’ Route Tables â†’ Create Route Table

Name: A4L-VPC1-RT-Private-A
VPC: A4L-VPC1
Action: Create
```

### **3.2. Route Table for AZ-B**
```yaml
ğŸ“ Create second route table

Name: A4L-VPC1-RT-Private-B
VPC: A4L-VPC1  
Action: Create
```

### **3.3. Route Table for AZ-C**
```yaml
ğŸ“ Create third route table

Name: A4L-VPC1-RT-Private-C
VPC: A4L-VPC1
Action: Create
```

---

## PHáº¦N 4: Configure Default Routes

### **4.1. Add Route to RT-Private-A**
```yaml
ğŸ“ Select RT-Private-A â†’ Routes tab â†’ Edit Routes

Add Route:
  Destination: 0.0.0.0/0
  Target: NAT Gateway â†’ A4L-VPC1-NATGW-A
Action: Save Changes
```

### **4.2. Add Route to RT-Private-B**
```yaml
ğŸ“ Select RT-Private-B â†’ Routes tab â†’ Edit Routes

Add Route:
  Destination: 0.0.0.0/0
  Target: NAT Gateway â†’ A4L-VPC1-NATGW-B
Action: Save Changes
```

### **4.3. Add Route to RT-Private-C**
```yaml
ğŸ“ Select RT-Private-C â†’ Routes tab â†’ Edit Routes

Add Route:
  Destination: 0.0.0.0/0
  Target: NAT Gateway â†’ A4L-VPC1-NATGW-C
Action: Save Changes
```

---

## PHáº¦N 5: Associate Route Tables vá»›i Subnets

### **5.1. Associate RT-Private-A vá»›i AZ-A Subnets**
```yaml
ğŸ“ Select RT-Private-A â†’ Subnet Associations â†’ Edit

Associate with:
  â˜‘ï¸ SN-Reserved-A
  â˜‘ï¸ SN-App-A  
  â˜‘ï¸ SN-DB-A

Action: Save Associations
```

### **5.2. Associate RT-Private-B vá»›i AZ-B Subnets**
```yaml
ğŸ“ Select RT-Private-B â†’ Subnet Associations â†’ Edit

Associate with:
  â˜‘ï¸ SN-Reserved-B
  â˜‘ï¸ SN-App-B
  â˜‘ï¸ SN-DB-B

Action: Save Associations  
```

### **5.3. Associate RT-Private-C vá»›i AZ-C Subnets**
```yaml
ğŸ“ Select RT-Private-C â†’ Subnet Associations â†’ Edit

Associate with:
  â˜‘ï¸ SN-Reserved-C
  â˜‘ï¸ SN-App-C
  â˜‘ï¸ SN-DB-C

Action: Save Associations
```

---

## PHáº¦N 6: Test NAT Gateway Functionality

### **6.1. Verify Connectivity**
```yaml
ğŸ“ Session Manager â†’ A4L-InternalTest

Test command: ping 1.1.1.1
Expected result: âœ… Success! Packets received
Meaning: Private instance cÃ³ Internet access qua NAT Gateway

Additional tests:
  ping google.com  âœ… DNS resolution works
  curl ifconfig.me  âœ… Shows NAT Gateway's public IP
```

### **6.2. Architecture Verification**
```yaml
ğŸ”„ Traffic flow Ä‘Ã£ hoáº¡t Ä‘á»™ng:

Private Instance (10.16.32.x) â†’ 
Route Table (RT-Private-A) â†’
NAT Gateway A (in AZ-A) â†’
Internet Gateway â†’
Internet

âœ… Multi-AZ resilient: Má»—i AZ cÃ³ NAT Gateway riÃªng
âœ… Fault tolerant: AZ fail khÃ´ng áº£nh hÆ°á»Ÿng AZ khÃ¡c
```

---

## PHáº¦N 7: Clean-up (Quan trá»ng Ä‘á»ƒ trÃ¡nh phÃ­)

### **7.1. Disassociate Route Tables**
```yaml
ğŸ“ Cho má»—i RT-Private (A, B, C):

Route Tables â†’ Select RT â†’ Subnet Associations â†’ Edit
Action: Uncheck táº¥t cáº£ subnets â†’ Save
Result: Subnets vá» láº¡i Main Route Table
```

### **7.2. Delete Route Tables**
```yaml
ğŸ“ Route Tables â†’ Select all RT-Private-* â†’ Actions â†’ Delete

Confirm: Delete Route Tables
Wait: Verify deletion completed
```

### **7.3. Delete NAT Gateways**
```yaml
ğŸ“ NAT Gateways â†’ Select each NAT Gateway â†’ Actions â†’ Delete

For each (A, B, C):
  Type: "delete" to confirm
  Click: Delete
  
â³ Wait: All status = "Deleted" (not "Deleting")
```

### **7.4. Release Elastic IPs**
```yaml
ğŸ“ VPC Console â†’ Elastic IPs

For each allocated IP:
  Select IP â†’ Actions â†’ Release Elastic IP Address
  Confirm: Release
  
âš ï¸ Important: Must release to avoid charges!
```

### **7.5. Delete CloudFormation Stack**
```yaml
ğŸ“ CloudFormation Console â†’ A4L Stack

Actions: Delete Stack
Confirm: Delete
Wait: DELETE_COMPLETE status

Result: All resources cleaned up
```

---

## ğŸ“š Kinh nghiá»‡m thá»±c táº¿ & ghi nhá»›

### **Key Learnings**
```yaml
âœ… Multi-AZ NAT design requirements:
  - 1 NAT Gateway per AZ (not per region!)
  - 1 Route table per AZ
  - Each private subnet routes to NAT in same AZ
  - Elastic IP for each NAT Gateway

âœ… Cost considerations:
  - NAT Gateway: ~$45/month + data charges
  - Elastic IP: Free while attached, $3.65/month if detached
  - Always clean up unused resources!
```

### **Common Mistakes**
```yaml
âŒ Routing all AZs to 1 NAT Gateway â†’ single point of failure
âŒ Cross-AZ routing â†’ unnecessary charges & latency  
âŒ Forgetting to associate route tables â†’ no connectivity
âŒ Not releasing Elastic IPs â†’ unexpected charges
âŒ Not waiting for NAT Gateway "Available" status
```

### **Troubleshooting Checklist**
```yaml
ğŸ› If private instance can't reach Internet:

1. âœ… NAT Gateway status = Available?
2. âœ… Route table has 0.0.0.0/0 â†’ NAT Gateway?
3. âœ… Route table associated with correct subnets?
4. âœ… Private subnet & NAT Gateway in same AZ?
5. âœ… Public subnet (with NAT) has IGW route?
6. âœ… Security Groups allow outbound traffic?
7. âœ… NACLs not blocking traffic?
```

---

## âœ… TÃ³m táº¯t achievements

1. **âœ… Multi-AZ NAT Architecture** implemented (production-ready!)
2. **âœ… Regional resilience** achieved (AZ failure won't break others)
3. **âœ… Private Internet access** working (ping 1.1.1.1 success)
4. **âœ… Proper clean-up** completed (no unexpected charges)

---

**Sau demo nÃ y, báº¡n Ä‘Ã£ master Ä‘Æ°á»£c multi-AZ NAT Gateway design - má»™t skill cá»±c quan trá»ng cho production AWS environments! Architecture nÃ y ready cho real-world deployment vÃ  handle Ä‘Æ°á»£c enterprise-scale traffic! ğŸš€**

**Tip:** Save kiáº¿n trÃºc nÃ y lÃ m template cho cÃ¡c project tÆ°Æ¡ng lai!
